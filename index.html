<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Gender Balance Tool</title>

<!-- Fonts & Libraries -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>

<!-- Style -->
<style>
body {
  font-family: 'Montserrat', Arial, sans-serif;
  background-color: #ffffff;
  color: #222;
  margin: 40px auto;
  max-width: 1000px;
  line-height: 1.5;
}

h2 {
  color: #333;
  margin-bottom: 8px;
}

p.small {
  font-size: 0.9rem;
  color: #555;
  margin-top: 0;
  margin-bottom: 20px;
}

textarea {
  width: 100%;
  height: 240px;
  margin-bottom: 15px;
  font-family: monospace;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: vertical;
}

button {
  padding: 10px 16px;
  margin-right: 8px;
  background: #518e5f;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

button:hover {
  background: #3f6f4b;
}

#chartContainer {
  width: 360px;
  margin-top: 20px;
  display: inline-block;
  vertical-align: top;
}

#wordCloud {
  width: 560px;
  height: 360px;
  border: 1px solid #eee;
  display: inline-block;
  vertical-align: top;
  margin-left: 20px;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 18px;
  font-size: 0.95rem;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: left;
}

th {
  background: #f4f4f4;
  font-weight: 600;
}

.small {
  font-size: 0.9rem;
  color:#555;
}

#results h3 {
  margin-bottom: 6px;
}

#results p {
  margin: 2px 0;
}
</style>
</head>
<body>
<h2>Gender Balance Analyzer â€” Bibliography Mode</h2>
<p class="small">Paste your bibliography, and this tool will extract author names, estimate gender, and visualize the results.</p>

<textarea id="inputText" placeholder="Paste bibliography here..."></textarea><br>
<button id="analyzeBtn">Analyze</button>
<button id="downloadBtn" style="display:none">Download CSV</button>

<div id="visuals" style="margin-top:20px;">
  <div id="chartContainer"><canvas id="genderChart"></canvas></div>
  <div id="wordCloud"></div>
</div>

<div id="results"></div>
<h4>Debug table (authors & first names)</h4>
<div id="debugTableWrap"></div>

<script>
async function analyzeText() {
  const text = document.getElementById('textInput').value;
  const loading = document.getElementById('loading');
  loading.style.display = 'block';

  // Regex to match common name formats: "Last, First", "First Last"
  const nameRegex = /([A-Z][a-z]+,\s*[A-Z][a-z]+(?:\s[A-Z]\.)?|[A-Z][a-z]+(?:\s[A-Z][a-z]+)+)/g;
  const matches = text.match(nameRegex) || [];
  const uniqueNames = [...new Set(matches.map(n => n.trim()))];

  const results = [];
  for (const full of uniqueNames) {
    let firstName = "";

    if (full.includes(",")) {
      // "Last, First" format
      const parts = full.split(",");
      if (parts[1]) {
        firstName = parts[1].trim().split(/\s+/)[0];
      }
    } else {
      // "First Last" format
      const parts = full.trim().split(/\s+/);
      firstName = parts[0];
    }

    firstName = firstName.replace(/[^A-Za-z]/g, ""); // remove punctuation

    if (!firstName) continue;

    // --- Try Genderize.io first ---
    let gender = "unknown";
    try {
      const res = await fetch(`https://api.genderize.io?name=${firstName}`);
      const data = await res.json();
      if (data.gender) {
        gender = data.gender;
      } else {
        // --- If Genderize fails, try Gender-API.com backup ---
        const backupRes = await fetch(`https://gender-api.com/get?name=${firstName}&key=f10b8738336d248c431e700b6a5cf18c63454df09aa0fb75cd03b85b3ecebbf2`);
        const backupData = await backupRes.json();
        if (backupData.gender) {
          gender = backupData.gender;
        }
      }
    } catch (e) {
      console.error("Error checking gender for", firstName, e);
    }

    results.push({ fullName: full, firstName, gender });
  }

  loading.style.display = 'none';
  displayResults(results);
}
</script>
</body>
</html>

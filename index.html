<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Gender Balance Tool</title>

<!-- Fonts & Libraries -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>

<!-- Style -->
<style>
body {
  font-family: 'Montserrat', Arial, sans-serif;
  background-color: #ffffff;
  color: #222;
  margin: 40px auto;
  max-width: 1000px;
  line-height: 1.5;
}

h2 {
  color: #333;
  margin-bottom: 8px;
}

p.small {
  font-size: 0.9rem;
  color: #555;
  margin-top: 0;
  margin-bottom: 20px;
}

textarea {
  width: 100%;
  height: 240px;
  margin-bottom: 15px;
  font-family: monospace;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: vertical;
}

button {
  padding: 10px 16px;
  margin-right: 8px;
  background: #518e5f;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

button:hover {
  background: #3f6f4b;
}

#chartContainer {
  width: 360px;
  margin-top: 20px;
  display: inline-block;
  vertical-align: top;
}

#wordCloud {
  width: 560px;
  height: 360px;
  border: 1px solid #eee;
  display: inline-block;
  vertical-align: top;
  margin-left: 20px;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 18px;
  font-size: 0.95rem;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: left;
}

th {
  background: #f4f4f4;
  font-weight: 600;
}

.small {
  font-size: 0.9rem;
  color:#555;
}

#results h3 {
  margin-bottom: 6px;
}

#results p {
  margin: 2px 0;
}
</style>
</head>
<body>
<h2>Gender Balance Analyzer â€” Bibliography Mode</h2>
<p class="small">Paste your bibliography, and this tool will extract author names, estimate gender, and visualize the results.</p>

<textarea id="inputText" placeholder="Paste bibliography here..."></textarea><br>
<button id="analyzeBtn">Analyze</button>
<button id="downloadBtn" style="display:none">Download CSV</button>

<div id="visuals" style="margin-top:20px;">
  <div id="chartContainer"><canvas id="genderChart"></canvas></div>
  <div id="wordCloud"></div>
</div>

<div id="results"></div>
<h4>Debug table (authors & first names)</h4>
<div id="debugTableWrap"></div>

<script>
// --- Utilities ---
const NON_NAME_WORDS = new Set(["Journal","Press","University","Review","Politics","Science","Sociology","American","Oxford","Cambridge","Harvard","Stanford","Quarterly","PNAS","RSF"]);

function normalizeWord(w) {
  w = w.replace(/[.,]/g,'').trim();
  if (!w) return '';
  return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
}

// --- Author extraction ---
function extractAuthors(entry) {
  const yearMatch = entry.match(/\b(17|18|19|20)\d{2}\b/);
  let block = yearMatch ? entry.slice(0, yearMatch.index) : entry;
  block = block.replace(/\bet al\.?/gi,'');
  
  // Split multiple authors: " and ", semicolon, or comma before capital letter
  let authors = block.split(/\s+and\s+|;|,(?=\s*[A-Z][a-z])/).map(a => a.trim()).filter(Boolean);

  const firstNames = [];
  authors.forEach(author => {
    if (!author) return;
    let fname = null;
    if (author.includes(',')) {
      let parts = author.split(',');
      if (parts.length >= 2) {
        let tokens = parts[1].trim().split(/\s+/).filter(t => t.length>1);
        if (tokens.length>0) fname = normalizeWord(tokens[0].replace(/\./g,''));
      }
    } else {
      let tokens = author.trim().split(/\s+/).filter(t => t.length>1);
      if (tokens.length>0) fname = normalizeWord(tokens[0].replace(/\./g,''));
    }
    if (fname && !NON_NAME_WORDS.has(fname)) firstNames.push({author: author, firstName: fname});
  });
  return firstNames;
}

// --- Gender APIs ---
const GENDER_API_KEY = "f10b8738336d248c431e700b6a5cf18c63454df09aa0fb75cd03b85b3ecebbf2";

async function getGender(name) {
  if (!name) return null;
  try {
    // Primary: Genderize.io
    let r1 = await fetch(`https://api.genderize.io?name=${encodeURIComponent(name)}`);
    let j1 = await r1.json();
    if (j1 && j1.gender) return j1.gender.toLowerCase();

    // Fallback: Gender-API.com
    let r2 = await fetch(`https://gender-api.com/get?name=${encodeURIComponent(name)}&key=${GENDER_API_KEY}`);
    let j2 = await r2.json();
    if (j2 && j2.gender) return j2.gender.toLowerCase();
  } catch (e) {
    console.warn('API error for', name, e);
  }
  return 'unknown';
}

// --- Visualizations ---
let chart = null;
function renderChart(male, female, unknown) {
  const ctx = document.getElementById('genderChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Male','Female','Unknown'],
      datasets:[{data:[male,female,unknown], backgroundColor:['#4a90e2','#ff69b4','#bbb']}]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });
}

function renderWordCloud(names, genders) {
  const list = names.map(n=>{
    const color = genders[n] === 'female' ? '#ff69b4' : genders[n]==='male' ? '#4a90e2':'#999';
    return [n, 20, color];
  });
  WordCloud(document.getElementById('wordCloud'),{
    list:list.map(l=>[l[0],l[1]]),
    color: word => { const f = list.find(x=>x[0]===word); return f?f[2]:'#000'; },
    rotateRatio:0.1
  });
}

// --- CSV ---
function makeCSV(authors, genders) {
  const rows=[['Author','First Name','Gender']];
  authors.forEach(a=>rows.push([a.author,a.firstName,genders[a.firstName]||'unknown']));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const btn = document.getElementById('downloadBtn');
  btn.style.display='inline-block';
  btn.onclick=()=>{ const a=document.createElement('a'); a.href=url; a.download='gender_analysis.csv'; a.click(); };
}

// --- Main ---
document.getElementById('analyzeBtn').addEventListener('click', async()=>{
  const text=document.getElementById('inputText').value;
  if(!text.trim()) return alert('Paste bibliography text.');
  const entries = text.split(/\n{2,}/).map(e=>e.trim()).filter(Boolean);
  let allAuthors=[];
  entries.forEach(entry=>{ allAuthors.push(...extractAuthors(entry)); });

  const uniqueFirstNames = [...new Set(allAuthors.map(a=>a.firstName))];
  const genderMap={};
  for(const name of uniqueFirstNames){
    genderMap[name]=await getGender(name);
    await new Promise(r=>setTimeout(r,150));
  }

  let male=0,female=0,unknown=0;
  allAuthors.forEach(a=>{
    const g = genderMap[a.firstName];
    if(g==='male') male++;
    else if(g==='female') female++;
    else unknown++;
  });

  document.getElementById('results').innerHTML = `<h3>Summary</h3>
    <p><b>Male authors:</b> ${male}</p>
    <p><b>Female authors:</b> ${female}</p>
    <p><b>Unknown:</b> ${unknown}</p>`;

  renderChart(male,female,unknown);
  renderWordCloud(uniqueFirstNames,genderMap);
  makeCSV(allAuthors,genderMap);

  let html='<table><tr><th>Full Author</th><th>First Name</th><th>Gender</th></tr>';
  allAuthors.forEach(a=>html+=`<tr><td>${a.author}</td><td>${a.firstName}</td><td>${genderMap[a.firstName]||'unknown'}</td></tr>`);
  html+='</table>';
  document.getElementById('debugTableWrap').innerHTML=html;
});
</script>
</body>
</html>
